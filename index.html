<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <title>IBONARIUM · DUAL ENGINE PULSE · 2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* ------------------------------------------------------------------
           CORE INTERFACE - PURE BLACK
           ------------------------------------------------------------------ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        ::-webkit-scrollbar {
            width: 0px;
        }

        body {
            background: #000;
            color: #dff;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            min-height: 100vh;
        }

        canvas#bg-layer {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
        }

        .app-container {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* Vertical centering */
            width: 100%;
            min-height: 100vh;
            padding: 20px;
        }

        .brand-header {
            font-size: 8px;
            color: #0af;
            text-transform: lowercase;
            letter-spacing: 6px;
            margin-bottom: 20px;
            opacity: 0.4;
            position: relative;
            z-index: 50;
        }

        /* ------------------------------------------------------------------
           MASTER HUB LAYOUT
           ------------------------------------------------------------------ */
        .master-hub {
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 20px;
            width: 100%;
            max-width: 1700px;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        /* LEFT SIDE */
        .left-hub {
            width: 405px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
            position: relative;
            z-index: 50;
        }

        #cosmic-status-line {
            font-size: 9px;
            color: #0f4;
            opacity: 0.8;
            letter-spacing: 1px;
        }

        #solar-hud {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px 12px;
            width: 100%;
        }

        .hud-item {
            font-size: 8px;
            text-transform: lowercase;
            display: flex;
            gap: 4px;
            align-items: center;
            cursor: pointer;
        }

        .status-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }

        .status-green {
            background: #0f4;
            box-shadow: 0 0 5px #0f4;
        }

        .status-yellow {
            background: #fa0;
            box-shadow: 0 0 5px #fa0;
        }

        .status-red {
            background: #f22;
            box-shadow: 0 0 10px #f22;
            animation: alert-pulse 1s infinite;
        }

        @keyframes alert-pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.3;
                transform: scale(1.2);
            }
        }

        #heatmap {
            display: grid;
            grid-template-columns: repeat(12, 12px);
            gap: 2px;
            margin: 5px 0;
        }

        .h-cell {
            width: 12px;
            height: 12px;
            border: 1px solid #111;
            transition: background 0.3s ease;
        }

        .sun-box {
            position: relative;
            width: 200px;
            height: 200px;
            background: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 10px 0;
            align-self: center;
            border: 1px solid rgba(0, 170, 255, 0.1);
            border-radius: 50%;
        }

        .sun-disk {
            width: 95%;
            height: 95%;
            border-radius: 50%;
            opacity: 1;
            z-index: 1;
            pointer-events: none;
            filter: contrast(1.2) brightness(1.1);
            box-shadow: 0 0 30px rgba(255, 100, 0, 0.2);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sun-disk.zoomed {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 95vh;
            height: 95vh;
            transform: translate(-50%, -50%) scale(var(--sun-zoom, 1));
            z-index: 5;
            box-shadow: 0 0 100px rgba(255, 100, 0, 0.5);
            background: rgba(0, 0, 0, 0.6);
        }

        .controls-row {
            display: flex;
            gap: 8px;
            align-self: center;
            align-items: center;
            position: relative;
            z-index: 1010;
        }

        .btn-lite {
            background: transparent;
            border: 1px solid rgba(0, 170, 255, 0.2);
            color: #0af;
            font-size: 7px;
            padding: 2px 6px;
            cursor: pointer;
            text-transform: lowercase;
        }

        .btn-lite.active {
            border-color: #fa0;
            color: #fa0;
        }

        .btn-zoom {
            font-weight: bold;
            font-size: 10px;
            padding: 1px 8px;
            border-color: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        #data-list-grid {
            font-size: 9px;
            color: #0f0;
            line-height: 1.1;
            width: 100%;
            border-top: 1px solid rgba(0, 170, 255, 0.1);
            padding-top: 10px;
            margin-top: 5px;
            column-count: 2;
        }

        .cat-title {
            margin: 8px 0 4px 0;
            font-size: 10px;
            color: #0af;
            font-weight: bold;
            text-transform: uppercase;
            column-span: all;
            border-bottom: 1px solid #003344;
        }

        .data-entry {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1px;
        }

        .d-lbl {
            color: #6cf;
        }

        .d-val-safe {
            color: #0f0;
        }

        .d-val-watch {
            color: #ffd700;
        }

        .d-val-warn {
            color: #ff8c00;
        }

        .d-val-danger {
            color: #f00;
        }

        .sys-terminal {
            width: 100%;
            height: 50px;
            font-size: 7px;
            color: #0af;
            opacity: 0.4;
            overflow: hidden;
            display: flex;
            flex-direction: column-reverse;
            gap: 2px;
            border-left: 2px solid rgba(0, 170, 255, 0.1);
            padding-left: 8px;
            margin-top: 10px;
        }

        /* RIGHT SIDE */
        .right-hub {
            width: 810px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            justify-content: flex-start;
            padding-top: 0;
            /* Removed fixed large padding to allow vertical centering to work */
            position: relative;
            z-index: 50;
        }

        .viz-box {
            width: 100%;
            height: 585px;
            /* Full height for graphs */
            position: relative;
            z-index: 1;
        }

        .compass-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 720px;
            height: 720px;
            z-index: 10;
            /* Above graphs */
            pointer-events: none;
            /* Don't block interaction */
            opacity: 0.8;
        }

        canvas#viz-canvas,
        canvas#compass-canvas {
            width: 100%;
            height: 100%;
        }

        /* OVERLAYS */
        #alert-hub {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 1000;
            pointer-events: none;
        }

        .f-msg {
            background: rgba(0, 0, 0, 0.95);
            border-right: 3px solid #f22;
            padding: 8px 12px;
            color: #f22;
            font-size: 8px;
            animation: slide-in 0.3s ease-out;
        }

        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        #clock-overlay {
            position: fixed;
            bottom: 8px;
            right: 10px;
            font-size: 8px;
            color: #6cf;
            opacity: 0.5;
            text-align: right;
            pointer-events: none;
        }

        @media (max-width: 1300px) {
            .master-hub {
                flex-direction: column;
                align-items: center;
            }

            .left-hub,
            .right-hub {
                width: 100%;
                max-width: 450px;
            }

            .right-hub {
                padding-top: 0;
            }

            .viz-box {
                height: 900px;
            }
        }
    </style>
</head>

<body>
    <canvas id="bg-layer"></canvas>
    <div id="alert-hub"></div>

    <div class="app-container">
        <div class="brand-header">ibonarium.pulse.terminal.v2026.plasma</div>

        <div class="master-hub">

            <!-- LEFT COLUMN -->
            <div class="left-hub">
                <div id="cosmic-status-line">СИСТЕМА IO ОНЛАЙН :: СИНХРОНІЗАЦІЯ...</div>

                <div id="solar-hud">
                    <div class="hud-item" onclick="solo(0)"><span class="status-dot status-green"
                            id="d0"></span>wind:<span id="v0">---</span></div>
                    <div class="hud-item" onclick="solo(1)"><span class="status-dot status-green"
                            id="d1"></span>dens:<span id="v1">---</span></div>
                    <div class="hud-item" onclick="solo(2)"><span class="status-dot status-green"
                            id="d2"></span>bt:<span id="v2">---</span></div>
                    <div class="hud-item" onclick="solo(3)"><span class="status-dot status-green"
                            id="d3"></span>temp:<span id="v3">---</span></div>
                    <div class="hud-item" onclick="solo(4)"><span class="status-dot status-green"
                            id="d4"></span>bz:<span id="v4">---</span></div>
                    <div class="hud-item" onclick="solo(5)"><span class="status-dot status-green"
                            id="d5"></span>phi:<span id="v5">---</span></div>
                    <div class="hud-item" onclick="solo(6)"><span class="status-dot status-green"
                            id="d6"></span>bx:<span id="v6">---</span></div>
                    <div class="hud-item" onclick="solo(7)"><span class="status-dot status-green"
                            id="d7"></span>by:<span id="v7">---</span></div>
                </div>

                <div id="heatmap"></div>

                <div class="sun-box">
                    <img id="sun-img" class="sun-disk"
                        src="https://sdo.gsfc.nasa.gov/assets/img/latest/latest_512_0171.jpg" alt="AIA">
                </div>

                <div class="controls-row">
                    <button class="btn-lite active" onclick="spec('0171', this)">171</button>
                    <button class="btn-lite" onclick="spec('0193', this)">193</button>
                    <button class="btn-lite" onclick="spec('0304', this)">304</button>
                    <button class="btn-lite" onclick="spec('0131', this)">131</button>
                    <span style="width:10px"></span>
                    <button class="btn-lite btn-zoom" onclick="zoom(0.2)">+</button>
                    <button class="btn-lite btn-zoom" onclick="zoom(-0.2)">-</button>
                </div>

                <div id="data-list-grid"></div>
                <div class="diag-row" id="diag-out"
                    style="font-size:7px; color:#fa0; opacity:0.8; height:10px; width:100%; text-align:center;">
                    моніторинг корони...</div>
                <div class="sys-terminal" id="sys-out"></div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="right-hub">
                <div class="viz-box">
                    <canvas id="viz-canvas"></canvas>
                </div>
                <div class="compass-box">
                    <canvas id="compass-canvas"></canvas>
                </div>
            </div>

        </div>
    </div>

    <div id="clock-overlay">—</div>

    <script>
        const proxy = 'https://corsproxy.io/?';

        // ------------------------------------------------------------------
        // STATE STORAGE
        // ------------------------------------------------------------------
        const S = {
            wind: 420, dens: 5, bt: 5, bz: 0, temp: 100000, phi: 0, bx: 0, by: 0,
            press: 1.2, kp: 0, dst: -5, f107: 150, sunspots: 80, convi: 0
        };
        const PEAKS = {};
        const HIST = { wind: [], dens: [], bt: [], bz: [], kp: [], convi: [] };
        const LIMIT = 60;
        const startTime = Date.now();
        let sunZoom = 1.0;

        const configs = [
            { l: 'швидкість вітру', k: 'wind', m: 1000, c: '#00f2ff', thr: 650 },
            { l: 'щільність протонів', k: 'dens', m: 50, c: '#ffcc00', thr: 15 },
            { l: 'магн.поле bt', k: 'bt', m: 50, c: '#ff0055', thr: 18 },
            { l: 'темп.плазми', k: 'temp', m: 1000000, c: '#33ff00', thr: 500000 },
            { l: 'комп.bz', k: 'bz', m: 25, c: '#9d00ff', thr: 12 },
            { l: 'кут phi', k: 'phi', m: 360, c: '#00ffea', thr: 300 },
            { l: 'комп.bx', k: 'bx', m: 25, c: '#ff6a00', thr: 15 },
            { l: 'комп.by', k: 'by', m: 25, c: '#ffffff', thr: 15 }
        ];

        // ------------------------------------------------------------------
        // RENDERING PIPELINES
        // ------------------------------------------------------------------
        const bgC = document.getElementById('bg-layer'); const bgCtx = bgC.getContext('2d');
        const vzC = document.getElementById('viz-canvas'); const vizCtx = vzC.getContext('2d');
        const cpC = document.getElementById('compass-canvas'); const cpCtx = cpC.getContext('2d');

        function resize() {
            const ratio = window.devicePixelRatio || 1;
            bgC.width = innerWidth * ratio; bgC.height = innerHeight * ratio;
            vzC.width = 810 * ratio; vzC.height = 585 * ratio;
            cpC.width = 720 * ratio; cpC.height = 720 * ratio;
            bgCtx.scale(ratio, ratio); vizCtx.scale(ratio, ratio); cpCtx.scale(ratio, ratio);
        }
        window.addEventListener('resize', resize); resize();

        const stars = [...Array(400)].map(() => ({ x: Math.random() * 2 - 1, y: Math.random() * 2 - 1, z: Math.random() * 2000, s: Math.random() * 1.2 + 0.5 }));
        const formulaTexts = ["P_dyn = ρv²", "λ = h/p", "E = hν", "∇·B = 0", "F = q(E + v×B)"];
        const formulaObjs = formulaTexts.map(f => ({ t: f, x: Math.random(), y: Math.random(), ph: Math.random() * 6.28 }));

        // ------------------------------------------------------------------
        // CORE FUNCTIONS
        // ------------------------------------------------------------------
        let activeSolo = -1, curSpec = '0171';

        function solo(i) { activeSolo = (activeSolo === i) ? -1 : i; log(`Соло синхр.: ${activeSolo === -1 ? 'ВИМК' : configs[i].l}`); }
        function spec(c, btn) {
            curSpec = c; document.querySelectorAll('.btn-lite').forEach(b => b.classList.remove('active')); btn.classList.add('active');
            document.getElementById('sun-img').src = `https://sdo.gsfc.nasa.gov/assets/img/latest/latest_512_${c}.jpg?t=` + Date.now();
        }
        function zoom(delta) {
            sunZoom = Math.max(1.0, Math.min(8.0, sunZoom + delta));
            const img = document.getElementById('sun-img');
            if (sunZoom > 1.0) {
                img.classList.add('zoomed');
                img.style.setProperty('--sun-zoom', sunZoom);
            } else {
                img.classList.remove('zoomed');
                img.style.removeProperty('--sun-zoom');
            }
            log(`Зум сонця: ${Math.round(sunZoom * 100)}%`);
        }
        function log(m) {
            const l = document.getElementById('sys-out');
            const e = document.createElement('div'); e.innerText = `${new Date().toLocaleTimeString()} :: ${m}`;
            l.prepend(e); if (l.childNodes.length > 15) l.removeChild(l.lastChild);
        }

        async function fetchAll() {
            try {
                const [p, m, k] = await Promise.all([
                    fetch(proxy + encodeURIComponent('https://services.swpc.noaa.gov/products/solar-wind/plasma-5-minute.json')).then(r => r.json()),
                    fetch(proxy + encodeURIComponent('https://services.swpc.noaa.gov/products/solar-wind/mag-5-minute.json')).then(r => r.json()),
                    fetch(proxy + encodeURIComponent('https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json')).then(r => r.json())
                ]);
                if (p && p.length > 1) {
                    const l = p[p.length - 1]; S.dens = parseFloat(l[1]) || 5; S.wind = parseFloat(l[2]) || 400; S.temp = parseFloat(l[3]) || 100000;
                }
                if (m && m.length > 1) {
                    const l = m[m.length - 1]; S.bx = parseFloat(l[1]); S.by = parseFloat(l[2]); S.bz = parseFloat(l[3]); S.phi = parseFloat(l[5]); S.bt = parseFloat(l[6]);
                }
                if (k && k.length > 1) S.kp = parseFloat(k[k.length - 1][1]) || 0;
                S.convi = (((S.wind / 1000) + (S.kp / 9) + (Math.abs(S.bz) / 20)) / 3 * 100).toFixed(1);

                const upH = (k, v) => { HIST[k].push(v); if (HIST[k].length > LIMIT) HIST[k].shift(); };
                upH('wind', S.wind); upH('dens', S.dens); upH('bt', S.bt); upH('bz', S.bz); upH('kp', S.kp); upH('convi', S.convi);
                updateUI();
            } catch (e) { log("Втрата зв'язку"); }
        }

        function updateUI() {
            let html = '<div class="cat-title">Сонячна іоносфера</div>';
            const heatmapColors = [];

            configs.forEach((c, i) => {
                const v = S[c.k];
                if (!PEAKS[c.k] || Math.abs(v) > PEAKS[c.k]) PEAKS[c.k] = Math.abs(v);

                const n = Math.min(1, Math.abs(v) / c.m);
                const statusClass = n > 0.8 ? 'status-red' : (n > 0.5 ? 'status-yellow' : 'status-green');
                const statusHex = n > 0.8 ? '#f22' : (n > 0.5 ? '#fa0' : '#0f4');

                document.getElementById(`v${i}`).innerText = v.toFixed(c.k === 'temp' ? 0 : 1);
                document.getElementById(`d${i}`).className = 'status-dot ' + statusClass;

                if (i === 4) html += '<div class="cat-title">Магнітосфера</div>';
                html += `<div class="data-entry"><span class="d-lbl">${c.l}</span><span class="d-val ${n > 0.8 ? 'd-val-danger' : (n > 0.5 ? 'd-val-watch' : 'd-val-safe')}">${v.toPrecision(4)}</span></div>`;

                for (let j = 0; j < 6; j++) heatmapColors.push(statusHex);
            });

            document.getElementById('data-list-grid').innerHTML = html;
            document.getElementById('cosmic-status-line').innerText = `ГОЛОВНА СИНХРОНІЗАЦІЯ :: ${new Date().toLocaleTimeString()} :: KP ${S.kp}`;

            const hm = document.getElementById('heatmap');
            hm.innerHTML = '';
            heatmapColors.forEach(color => {
                const cl = document.createElement('div');
                cl.className = 'h-cell';
                cl.style.background = color;
                cl.style.boxShadow = `0 0 4px ${color}`;
                hm.appendChild(cl);
            });
        }

        function drawBackground(t) {
            bgCtx.fillStyle = '#000'; bgCtx.fillRect(0, 0, innerWidth, innerHeight);
            const cx = innerWidth / 2, cy = innerHeight / 2;
            stars.forEach(s => { s.z -= 1.8; if (s.z <= 0) s.z = 2000; let k = 400 / s.z; let px = s.x * k * innerWidth + cx, py = s.y * k * innerHeight + cy; if (px < 0 || px > innerWidth || py < 0 || py > innerHeight) return; bgCtx.fillStyle = `rgba(180,240,255,${1 - s.z / 2000})`; bgCtx.beginPath(); bgCtx.arc(px, py, (1 - s.z / 2000) * s.s, 0, 6.28); bgCtx.fill(); });
            formulaObjs.forEach(f => { const a = Math.sin(t * 0.5 + f.ph) * 0.2 + 0.1; bgCtx.fillStyle = `rgba(0,180,255,${a})`; bgCtx.font = '10px Courier New'; bgCtx.fillText(f.t, f.x * innerWidth + Math.sin(t + f.ph) * 20, f.y * innerHeight); });
            for (let i = 0; i < 12; i++) {
                bgCtx.beginPath(); const ang = t * 0.04 + (i * Math.PI * 2 / 12);
                const r1 = 200 + Math.sin(t + i) * 60, r2 = 700 + Math.cos(t * 0.4 + i) * 120;
                bgCtx.moveTo(cx + Math.cos(ang) * r1, cy + Math.sin(ang) * r1);
                bgCtx.lineTo(cx + Math.cos(ang) * r2, cy + Math.sin(ang) * r2);
                bgCtx.strokeStyle = `rgba(0, 255, 255, ${0.04 + 0.04 * Math.sin(t * 0.5)})`;
                bgCtx.lineWidth = 1; bgCtx.stroke();
            }
        }

        function drawViz(t) {
            vizCtx.clearRect(0, 0, 810, 585);

            const drawG = (lbl, hist, x, y, cw, ch, col, max, thr) => {
                vizCtx.save(); vizCtx.translate(x, y); // No float movement for graphs
                vizCtx.strokeStyle = 'rgba(0,180,255,0.15)'; vizCtx.lineWidth = 1;
                for (let i = 0; i <= 3; i++) { vizCtx.beginPath(); vizCtx.moveTo(0, i * ch / 3); vizCtx.lineTo(cw, i * ch / 3); vizCtx.stroke(); }
                vizCtx.strokeStyle = 'rgba(0,180,255,0.05)';
                for (let i = 0; i <= 4; i++) { vizCtx.beginPath(); vizCtx.moveTo(i * cw / 4, 0); vizCtx.lineTo(i * cw / 4, ch); vizCtx.stroke(); }

                if (hist.length > 0) {
                    const last = hist[hist.length - 1] || 0;
                    const isAlert = Math.abs(last) > thr;
                    vizCtx.beginPath();
                    hist.forEach((v, i) => {
                        const gx = i * (cw / (LIMIT - 1)); const gy = ch - (Math.abs(v) / max) * ch;
                        i === 0 ? vizCtx.moveTo(gx, gy) : vizCtx.lineTo(gx, gy);
                    });
                    vizCtx.strokeStyle = isAlert ? '#f22' : col; vizCtx.lineWidth = 1.8; vizCtx.stroke();

                    hist.forEach((v, i) => {
                        if (i % 5 === 0 || i === hist.length - 1) {
                            const gx = i * (cw / (LIMIT - 1)); const gy = ch - (Math.abs(v) / max) * ch;
                            vizCtx.beginPath(); vizCtx.arc(gx, gy, 2, 0, 6.28); vizCtx.fillStyle = isAlert ? '#f22' : col; vizCtx.fill();
                            if (i === hist.length - 1) {
                                vizCtx.fillStyle = '#fff'; vizCtx.font = 'bold 8px Courier New';
                                vizCtx.fillText(parseFloat(v).toFixed(1), gx + 4, gy + 3);
                            }
                        }
                    });
                }
                vizCtx.fillStyle = col; vizCtx.font = '8px Courier New'; vizCtx.fillText(lbl, 0, -6);
                vizCtx.restore();
            };

            const gw = 234, gh = 135, gapX = 270, gapY = 198;
            // ROW 1
            drawG('АНАЛІТИКА.ШВИДКОСТІ', HIST.wind, 20, 60, gw, gh, '#0af', 1000, 650);
            drawG('АНАЛІТИКА.ПРОТОНІВ', HIST.dens, 20 + gapX, 60, gw, gh, '#ff0', 50, 15);
            drawG('АНАЛІТИКА.MAG_BT', HIST.bt, 20 + gapX * 2, 60, gw, gh, '#f05', 50, 18);
            // ROW 2
            drawG('ІНДЕКС.KP', HIST.kp, 20, 60 + gapY, gw, gh, '#f80', 9, 5);
            drawG('АНАЛІТИКА.MAG_BZ', HIST.bz, 20 + gapX, 60 + gapY, gw, gh, '#44f', 25, 12);
            drawG('ІНДЕКС.ХАОСУ', HIST.convi, 20 + gapX * 2, 60 + gapY, gw, gh, '#0ff', 100, 70);
        }

        function drawCompass(t) {
            cpCtx.clearRect(0, 0, 720, 720);
            const cx = 360, cy = 360;
            const globalPulse = 1 + Math.sin(t * 1.5) * 0.02;
            const radius = 288 * globalPulse; // Decreased by 10% (320 -> 288)
            const chaos = S.convi / 100;

            // --- TACTICAL GEARS (COUNTER-ROTATING RINGS) ---
            for (let i = 1; i <= 6; i++) {
                const r = (radius / 6) * i;
                const rot = i % 2 === 0 ? t * (0.15 + i * 0.04) : -t * (0.08 + i * 0.02);

                cpCtx.save();
                cpCtx.translate(cx, cy);
                cpCtx.rotate(rot);
                cpCtx.strokeStyle = `rgba(0, 255, 255, ${0.04 + (i / 30)})`;

                if (i % 2 === 0) {
                    cpCtx.setLineDash([8, 20]);
                    cpCtx.lineWidth = 2.5;
                } else {
                    cpCtx.setLineDash([30, 15]);
                    cpCtx.lineWidth = 1;
                }

                cpCtx.beginPath();
                cpCtx.arc(0, 0, r, 0, Math.PI * 2);
                cpCtx.stroke();

                if (i === 4 || i === 6) {
                    cpCtx.beginPath();
                    for (let h = 0; h < 8; h++) {
                        const a = h * Math.PI * 2 / 8;
                        h === 0 ? cpCtx.moveTo(Math.cos(a) * r, Math.sin(a) * r) : cpCtx.lineTo(Math.cos(a) * r, Math.sin(a) * r);
                    }
                    cpCtx.closePath();
                    cpCtx.globalAlpha = 0.08;
                    cpCtx.stroke();
                }
                cpCtx.restore();
            }
            cpCtx.setLineDash([]);

            // --- ANALYTIC SIDEBARS (EXPANDED POSITION) ---
            cpCtx.fillStyle = 'rgba(0, 255, 255, 0.4)';
            cpCtx.font = '7px Space Mono';
            cpCtx.textAlign = 'left';

            const telemetry = [
                `CHAOS_IDX: ${(chaos * 100).toFixed(2)}%`,
                `VECT_STABILITY: ${(100 - chaos * 80).toFixed(1)}%`,
                `SYNC_LATENCY: ${(15 + Math.sin(t * 10) * 5).toFixed(0)}ms`,
                `DATA_FIELD_EXP: ${(radius / 3.2).toFixed(1)}u`
            ];
            telemetry.forEach((txt, i) => cpCtx.fillText(`> ${txt}`, cx - radius - 50, cy - radius + 40 + i * 14));

            cpCtx.textAlign = 'right';
            let sysState = chaos > 0.6 ? 'ION_STORM_ALERT' : (chaos > 0.3 ? 'VECTOR_SHIFT' : 'NULL_STATE');
            cpCtx.fillText(`CORE_LINK: STB_01`, cx + radius + 50, cy - radius + 40);
            cpCtx.fillText(`MAP_RADIUS: ${radius.toFixed(0)}px`, cx + radius + 50, cy - radius + 54);

            // --- ENERGY RADIATOR ---
            for (let i = 0; i < 4; i++) {
                const life = (t * 0.4 + i / 4) % 1;
                const r = life * radius;
                cpCtx.strokeStyle = `rgba(0, 255, 255, ${0.25 * (1 - life)})`;
                cpCtx.beginPath();
                cpCtx.arc(cx, cy, r, 0, Math.PI * 2);
                cpCtx.stroke();
            }

            // --- PERIMETER KINETICS (WIDE) ---
            cpCtx.save();
            cpCtx.translate(cx, cy);
            cpCtx.rotate(t * 0.05);
            for (let a = 0; a < 360; a += 15) {
                const ang = a * Math.PI / 180;
                const len = a % 90 === 0 ? 20 : 8;
                cpCtx.strokeStyle = 'rgba(0, 255, 255, 0.3)';
                cpCtx.beginPath();
                cpCtx.moveTo(Math.cos(ang) * (radius + 5), Math.sin(ang) * (radius + 5));
                cpCtx.lineTo(Math.cos(ang) * (radius + 5 + len), Math.sin(ang) * (radius + 5 + len));
                cpCtx.stroke();

                if (a % 30 === 0) {
                    cpCtx.fillStyle = '#0ff';
                    cpCtx.font = '6px Space Mono';
                    cpCtx.fillText(a + '°', Math.cos(ang) * (radius + 30), Math.sin(ang) * (radius + 30));
                }
            }
            cpCtx.restore();

            // --- DATA POINTS & EXPANDED MAPPING ---
            const points = configs.map((c, i) => {
                const angle = (i * Math.PI * 2 / 8) + t * 0.08;
                const val = S[c.k] || 0;
                const n = Math.min(1, Math.abs(val) / c.m);
                // Expand mapping logic: r starts further out and grows larger
                const r = (n * radius * 0.7) + (radius * 0.3);
                return { x: cx + Math.cos(angle) * r, y: cy + Math.sin(angle) * r, color: c.c, norm: n, label: c.k.toUpperCase(), ang: angle, r: r, val: val };
            });

            // Energy Web (Mesh)
            cpCtx.beginPath();
            cpCtx.setLineDash([2, 4]);
            cpCtx.lineWidth = 1;
            cpCtx.strokeStyle = `rgba(0, 255, 255, ${0.15 + chaos * 0.4})`;
            points.forEach((p, i) => { i === 0 ? cpCtx.moveTo(p.x, p.y) : cpCtx.lineTo(p.x, p.y); });
            cpCtx.closePath();
            cpCtx.stroke();
            cpCtx.setLineDash([]);

            // DATA FLOW
            points.forEach((p, i) => {
                const pc = 4;
                for (let j = 0; j < pc; j++) {
                    const pLife = (t * (0.3 + p.norm) + j / pc) % 1;
                    const pr = (radius * 0.3) + (pLife * (p.r - radius * 0.3));
                    const px = cx + Math.cos(p.ang) * pr;
                    const py = cy + Math.sin(p.ang) * pr;
                    cpCtx.fillStyle = p.color;
                    cpCtx.globalAlpha = 0.3 * (1 - pLife);
                    cpCtx.beginPath();
                    cpCtx.arc(px, py, 1.2, 0, 6.28);
                    cpCtx.fill();
                }

                cpCtx.strokeStyle = p.color;
                cpCtx.lineWidth = 2;
                cpCtx.globalAlpha = 1.0;
                const s = 4;
                cpCtx.beginPath();
                cpCtx.moveTo(p.x - s, p.y); cpCtx.lineTo(p.x + s, p.y);
                cpCtx.moveTo(p.x, p.y - s); cpCtx.lineTo(p.x, p.y + s);
                cpCtx.stroke();

                cpCtx.fillStyle = '#fff';
                cpCtx.font = 'bold 7px Space Mono';
                cpCtx.textAlign = 'left';
                cpCtx.fillText(`[${p.label}]`, p.x + 8, p.y - 12);
                cpCtx.fillText(`MAG:${Math.round(p.norm * 100)}%`, p.x + 8, p.y - 4);

                if (p.norm > 0.8) {
                    cpCtx.strokeStyle = '#f22';
                    const b = 20 + Math.sin(t * 10) * 5;
                    cpCtx.save();
                    cpCtx.translate(p.x, p.y);
                    cpCtx.rotate(t * 3);
                    cpCtx.strokeRect(-b / 2, -b / 2, b, b);
                    cpCtx.restore();
                }
            });

            // SCANNING LINE
            const scanAngle = (t * 2) % (Math.PI * 2);
            cpCtx.strokeStyle = 'rgba(0,255,255,0.4)';
            cpCtx.beginPath();
            cpCtx.moveTo(cx, cy);
            cpCtx.lineTo(cx + Math.cos(scanAngle) * radius, cy + Math.sin(scanAngle) * radius);
            cpCtx.stroke();

            // HEADER
            cpCtx.fillStyle = 'rgba(0, 255, 255, 0.5)';
            cpCtx.font = 'bold 11px Space Mono';
            cpCtx.textAlign = 'center';
            cpCtx.fillText('EXPANDED_ANALYTIC_FIELD // v.4.5', cx, cy - radius - 60);
        }

        function loop() {
            try {
                const t = performance.now() * 0.001;
                drawBackground(t); drawViz(t); drawCompass(t);
                const now = new Date();
                document.getElementById('clock-overlay').innerHTML = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}<br>ТЕРМІНАЛ АКТИВНИЙ: +${Math.floor((Date.now() - startTime) / 1000)}с`;
            } catch (e) { }
            requestAnimationFrame(loop);
        }

        fetchAll(); setInterval(fetchAll, 5000);
        setInterval(() => { document.getElementById('sun-img').src = `https://sdo.gsfc.nasa.gov/assets/img/latest/latest_512_${curSpec}.jpg?t=` + Date.now(); }, 600000);
        loop();
    </script>
</body>

</html>
